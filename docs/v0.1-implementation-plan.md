# Haiti City Portal v0.1 Implementation Plan

**Version:** 0.1.0  
**Target:** MVP Launch  
**Focus:** Low-bandwidth multilingual shell + basic navigation before complex features

---

## Overview

This plan breaks down the v0.1 MVP into **7 focused milestones** that prioritize:
1. **Multilingual infrastructure** (5 languages: HT, FR, ES, PT-BR, EN)
2. **Low-bandwidth optimization** (2G/3G survivable)
3. **Core municipal features** (announcements, services directory, basic forms)
4. **Foundational architecture** (i18n, database, auth, API layer)

Each milestone is designed to be a standalone GitHub issue with clear deliverables.

---

## Milestone 1: Multilingual Infrastructure Setup

**Priority:** Critical  
**Estimated Effort:** 3-5 days  
**Dependencies:** None

### User-Facing Behavior
- [ ] Language switcher appears in header, mobile menu, and footer
- [ ] Users can switch between 5 languages (Haitian Creole, French, Spanish, Portuguese, English)
- [ ] Language preference persists across sessions (localStorage + user profile)
- [ ] All UI text displays in selected language with graceful fallback to English
- [ ] Page layout remains stable across all languages (no text overflow or breaking)

### Technical Implementation

#### Files to Create
- [ ] `src/i18n/config.ts` — i18n configuration with next-intl
- [ ] `src/i18n/request.ts` — Server-side locale detection
- [ ] `src/middleware.ts` — Locale routing middleware
- [ ] `src/messages/en.json` — English base translations
- [ ] `src/messages/ht.json` — Haitian Creole translations
- [ ] `src/messages/fr.json` — French translations
- [ ] `src/messages/es.json` — Spanish translations
- [ ] `src/messages/pt-BR.json` — Brazilian Portuguese translations
- [ ] `src/components/LanguageSwitcher.tsx` — Language switcher component

#### Files to Modify
- [ ] `src/app/layout.tsx` — Wrap with NextIntlClientProvider, add locale param
- [ ] `src/app/(public)/page.tsx` — Replace hardcoded strings with translation keys
- [ ] `src/components/nav/Navbar.tsx` — Add language switcher to header
- [ ] `src/components/layout/Footer.tsx` — Add language switcher to footer
- [ ] `next.config.ts` — Add i18n configuration

#### New Folders
- [ ] `src/i18n/` — Internationalization utilities
- [ ] `src/messages/` — Translation JSON files (already exists, populate it)

#### Configuration Changes
- [ ] Update `next.config.ts` with locale routing
- [ ] Add locale detection order: user profile → localStorage → browser → default (HT)
- [ ] Configure translation bundle lazy-loading (< 50KB per language)

### Acceptance Criteria
- [ ] All 5 languages are selectable and functional
- [ ] Language preference persists after page reload
- [ ] No missing translation warnings in console
- [ ] Layout is stable across all languages on mobile and desktop
- [ ] Automated test: missing keys checker passes

---

## Milestone 2: Database Schema for Multilingual Content

**Priority:** Critical  
**Estimated Effort:** 2-3 days  
**Dependencies:** Milestone 1

### User-Facing Behavior
- [ ] Announcements display in user's selected language
- [ ] Municipality services show localized titles and descriptions
- [ ] Events appear with multilingual metadata
- [ ] Fallback to English if translation is missing for any content

### Technical Implementation

#### Files to Modify
- [ ] `src/db/schema.ts` — Add multilingual fields to existing tables
  - Add `announcements` table with JSONB multilingual fields
  - Add `services` table with JSONB multilingual fields
  - Add `municipalities` table with basic info
  - Modify `events` table to support multilingual title/description
  - Add `language` field to `users` table (already has role, add language preference)

#### Database Migrations
- [ ] Create migration for `announcements` table
- [ ] Create migration for `services` table
- [ ] Create migration for `municipalities` table
- [ ] Update `events` table schema
- [ ] Update `users` table with language preference

#### Example Schema Structure
```typescript
// Announcements with multilingual content
announcements: {
  id: uuid,
  municipality_id: uuid,
  title: jsonb, // { en: "...", ht: "...", fr: "...", es: "...", pt-BR: "..." }
  body: jsonb,  // { en: "...", ht: "...", fr: "...", es: "...", pt-BR: "..." }
  publish_date: timestamp,
  created_at: timestamp
}
```

#### Files to Create
- [ ] `src/db/migrations/001_multilingual_content.sql` — Migration script
- [ ] `src/lib/i18n-helpers.ts` — Helper functions to extract localized content from JSONB

### Acceptance Criteria
- [ ] Database schema supports all 5 languages
- [ ] Seed data includes sample announcements in all languages
- [ ] Helper functions correctly extract localized content based on user language
- [ ] Database push completes without errors: `npm run db:push`

---

## Milestone 3: Low-Bandwidth Optimization & Performance

**Priority:** High  
**Estimated Effort:** 2-4 days  
**Dependencies:** Milestone 1

### User-Facing Behavior
- [ ] Pages load quickly on 2G/3G connections (< 3s initial load)
- [ ] Images are optimized and lazy-loaded
- [ ] Critical content displays before non-critical assets load
- [ ] Offline mode shows cached content for key pages
- [ ] Progressive Web App (PWA) installable on mobile devices

### Technical Implementation

#### Files to Create
- [ ] `public/manifest.json` — PWA manifest with multilingual names
- [ ] `src/app/service-worker.ts` — Service worker for offline caching
- [ ] `src/components/OfflineIndicator.tsx` — Offline status indicator
- [ ] `src/lib/image-optimizer.ts` — Image optimization utilities

#### Files to Modify
- [ ] `src/app/layout.tsx` — Add PWA meta tags, preconnect hints
- [ ] `next.config.ts` — Enable image optimization, compression
- [ ] `tailwind.config.ts` — Optimize CSS bundle size
- [ ] All page components — Add loading states and skeleton screens

#### Configuration Changes
- [ ] Enable Next.js image optimization
- [ ] Configure service worker caching strategy (cache-first for static assets)
- [ ] Add resource hints (preconnect, dns-prefetch)
- [ ] Implement lazy loading for below-the-fold content
- [ ] Reduce JavaScript bundle size (code splitting, tree shaking)

#### Caching Strategy
- [ ] Cache static assets (CSS, JS, fonts) — cache-first
- [ ] Cache translation files — cache-first with network fallback
- [ ] Cache API responses — network-first with cache fallback
- [ ] Cache images — cache-first with size limits

### Acceptance Criteria
- [ ] Lighthouse Performance score > 90 on mobile
- [ ] First Contentful Paint (FCP) < 1.5s on 3G
- [ ] Total page weight < 500KB (excluding images)
- [ ] Translation bundles < 50KB per language
- [ ] PWA installable on Android and iOS
- [ ] Offline mode works for homepage, announcements, and services

---

## Milestone 4: Municipal Services Directory & Announcements

**Priority:** High  
**Estimated Effort:** 3-5 days  
**Dependencies:** Milestones 1, 2

### User-Facing Behavior
- [ ] Citizens can browse a directory of municipal services (multilingual)
- [ ] Each service shows: title, description, requirements, contact info
- [ ] Services are categorized (e.g., permits, licensing, payments, records)
- [ ] Announcements appear on homepage and dedicated announcements page
- [ ] Announcements show: title, date, category, full content (multilingual)
- [ ] Users can filter announcements by category and date

### Technical Implementation

#### Files to Create
- [ ] `src/app/(public)/services/page.tsx` — Services directory page
- [ ] `src/app/(public)/announcements/page.tsx` — Announcements listing page
- [ ] `src/app/(public)/announcements/[id]/page.tsx` — Single announcement detail page
- [ ] `src/components/ServiceCard.tsx` — Service card component
- [ ] `src/components/AnnouncementCard.tsx` — Announcement card component
- [ ] `src/app/api/services/route.ts` — API endpoint for services
- [ ] `src/app/api/announcements/route.ts` — API endpoint for announcements
- [ ] `src/features/services/services-repository.ts` — Database queries for services
- [ ] `src/features/announcements/announcements-repository.ts` — Database queries for announcements

#### Files to Modify
- [ ] `src/app/(public)/page.tsx` — Fetch real announcements from database
- [ ] `src/db/seed.ts` — Add seed data for services and announcements (all 5 languages)

#### API Endpoints
- [ ] `GET /api/services?lang=ht` — Returns localized services
- [ ] `GET /api/announcements?lang=ht&category=emergency` — Returns filtered announcements
- [ ] `GET /api/announcements/[id]?lang=ht` — Returns single announcement

### Acceptance Criteria
- [ ] Services directory displays at least 10 sample services in all languages
- [ ] Announcements page shows at least 5 sample announcements
- [ ] Filtering and sorting work correctly
- [ ] API endpoints respect `Accept-Language` header and `?lang=` query param
- [ ] All content displays correctly in all 5 languages
- [ ] Mobile-responsive layout

---

## Milestone 5: User Authentication & Profiles

**Priority:** High  
**Estimated Effort:** 3-4 days  
**Dependencies:** Milestone 2

### User-Facing Behavior
- [ ] Citizens can create an account with email/password
- [ ] Users can log in and log out
- [ ] User profile stores: name, email, language preference, municipality
- [ ] Language preference in profile overrides browser/localStorage
- [ ] Protected routes redirect to login if not authenticated
- [ ] User dashboard shows personalized content (submitted issues, saved services)

### Technical Implementation

#### Files to Modify
- [ ] `src/auth.ts` — Configure NextAuth with credentials provider
- [ ] `src/app/(public)/login/page.tsx` — Update login form to save language preference
- [ ] `src/db/schema.ts` — Ensure `users` table has `language` field
- [ ] `src/app/layout.tsx` — Fetch user language preference from session

#### Files to Create
- [ ] `src/app/(public)/register/page.tsx` — User registration page
- [ ] `src/app/(protected)/dashboard/page.tsx` — User dashboard
- [ ] `src/app/(protected)/profile/page.tsx` — User profile settings
- [ ] `src/app/api/auth/register/route.ts` — Registration API endpoint
- [ ] `src/features/auth/auth-repository.ts` — User authentication queries
- [ ] `src/components/auth/LoginForm.tsx` — Login form component
- [ ] `src/components/auth/RegisterForm.tsx` — Registration form component

#### Authentication Flow
- [ ] Registration: email, password, name, language, municipality (optional)
- [ ] Login: email, password → create session
- [ ] Session stores: user ID, email, name, role, language, municipality
- [ ] Logout: destroy session, redirect to homepage

### Acceptance Criteria
- [ ] Users can register with all required fields
- [ ] Login works and creates a valid session
- [ ] Language preference from profile is applied on login
- [ ] Protected routes are inaccessible without authentication
- [ ] User dashboard displays personalized content
- [ ] Profile page allows updating language and municipality

---

## Milestone 6: Basic Service Request Forms

**Priority:** Medium  
**Estimated Effort:** 3-5 days  
**Dependencies:** Milestones 1, 2, 5

### User-Facing Behavior
- [ ] Citizens can submit service requests through digital forms
- [ ] Forms are multilingual with localized labels and validation messages
- [ ] Common forms: permit application, licensing request, general inquiry
- [ ] Form submissions are saved to database with status tracking
- [ ] Users receive confirmation with reference number
- [ ] Users can view their submitted requests in dashboard

### Technical Implementation

#### Files to Create
- [ ] `src/app/(protected)/requests/new/page.tsx` — New request form page
- [ ] `src/app/(protected)/requests/page.tsx` — User's request history
- [ ] `src/app/(protected)/requests/[id]/page.tsx` — Single request detail
- [ ] `src/components/forms/ServiceRequestForm.tsx` — Reusable form component
- [ ] `src/app/api/requests/route.ts` — API for creating/listing requests
- [ ] `src/features/requests/requests-repository.ts` — Database queries
- [ ] `src/db/schema.ts` — Add `service_requests` table

#### Database Schema
```typescript
service_requests: {
  id: uuid,
  user_id: uuid,
  service_type: text, // "permit", "license", "inquiry"
  title: text,
  description: text,
  status: text, // "submitted", "in_review", "approved", "rejected"
  reference_number: text,
  municipality_id: uuid,
  created_at: timestamp,
  updated_at: timestamp
}
```

#### API Endpoints
- [ ] `POST /api/requests` — Submit new request
- [ ] `GET /api/requests` — List user's requests
- [ ] `GET /api/requests/[id]` — Get single request
- [ ] `PATCH /api/requests/[id]` — Update request status (admin only)

### Acceptance Criteria
- [ ] Forms are fully translated in all 5 languages
- [ ] Validation messages appear in user's language
- [ ] Form submissions save correctly to database
- [ ] Reference number is generated and displayed
- [ ] Users can view their request history
- [ ] Status updates are visible in dashboard

---

## Milestone 7: Payment Integration Foundation

**Priority:** Medium  
**Estimated Effort:** 4-6 days  
**Dependencies:** Milestones 2, 5

### User-Facing Behavior
- [ ] Citizens can view outstanding municipal fees (property tax, service fees)
- [ ] Payment options: MonCash (for Haiti), Stripe (for diaspora)
- [ ] Payment flow is multilingual
- [ ] Users receive payment confirmation and receipt
- [ ] Payment history is visible in user dashboard
- [ ] Diaspora users can pay in USD/EUR with Stripe

### Technical Implementation

#### Files to Create
- [ ] `src/app/(protected)/payments/page.tsx` — Payment dashboard
- [ ] `src/app/(protected)/payments/new/page.tsx` — New payment page
- [ ] `src/app/(protected)/payments/[id]/receipt/page.tsx` — Payment receipt
- [ ] `src/components/payments/MonCashButton.tsx` — MonCash payment button
- [ ] `src/components/payments/StripeCheckout.tsx` — Stripe checkout component
- [ ] `src/app/api/payments/moncash/route.ts` — MonCash webhook handler
- [ ] `src/app/api/payments/stripe/route.ts` — Stripe webhook handler
- [ ] `src/features/payments/payment-repository.ts` — Database queries
- [ ] `src/lib/moncash.ts` — MonCash API client
- [ ] `src/lib/stripe.ts` — Stripe API client

#### Database Schema
```typescript
payments: {
  id: uuid,
  user_id: uuid,
  amount: decimal,
  currency: text, // "HTG", "USD", "EUR"
  type: text, // "property_tax", "service_fee", "permit_fee"
  status: text, // "pending", "completed", "failed"
  gateway: text, // "moncash", "stripe"
  gateway_transaction_id: text,
  municipality_id: uuid,
  created_at: timestamp
}
```

#### API Endpoints
- [ ] `POST /api/payments/moncash` — Initiate MonCash payment
- [ ] `POST /api/payments/stripe` — Create Stripe checkout session
- [ ] `POST /api/payments/moncash/webhook` — Handle MonCash callbacks
- [ ] `POST /api/payments/stripe/webhook` — Handle Stripe webhooks
- [ ] `GET /api/payments` — List user's payment history

#### Configuration
- [ ] Add MonCash API credentials to `.env.local`
- [ ] Add Stripe API keys to `.env.local`
- [ ] Configure webhook endpoints in MonCash and Stripe dashboards

### Acceptance Criteria
- [ ] MonCash payment flow works for HTG payments
- [ ] Stripe payment flow works for USD/EUR payments
- [ ] Payment status updates correctly via webhooks
- [ ] Receipt is generated and downloadable
- [ ] Payment history displays in user dashboard
- [ ] All payment UI is multilingual
- [ ] Error handling for failed payments

---

## Additional Tasks (Cross-Cutting Concerns)

### Testing & Quality Assurance
- [ ] Set up automated i18n tests (missing keys, duplicate keys)
- [ ] Add E2E tests for critical user flows (registration, login, service request, payment)
- [ ] Test all pages in all 5 languages on mobile and desktop
- [ ] Test offline mode functionality
- [ ] Performance testing on 2G/3G connections
- [ ] Accessibility audit (WCAG 2.1 AA compliance)

### Documentation
- [ ] Update README with i18n setup instructions
- [ ] Document translation workflow (English → machine translation → human review)
- [ ] Create API documentation for all endpoints
- [ ] Write deployment guide for municipalities
- [ ] Create user guide (multilingual)

### DevOps & Infrastructure
- [ ] Set up CI/CD pipeline (GitHub Actions)
- [ ] Configure staging and production environments
- [ ] Set up database backups
- [ ] Configure monitoring and logging (error tracking, performance monitoring)
- [ ] Set up CDN for static assets

---

## Success Metrics for v0.1

- [ ] **Multilingual:** All 5 languages fully functional with >95% translation coverage
- [ ] **Performance:** Lighthouse score >90, FCP <1.5s on 3G
- [ ] **Accessibility:** WCAG 2.1 AA compliant
- [ ] **Functionality:** Core user flows work end-to-end (register → login → submit request → pay fee)
- [ ] **Adoption:** Ready for pilot deployment in 1-2 municipalities

---

## Notes

- **Prioritization:** Milestones 1-4 are critical path for v0.1 launch
- **Parallel Work:** Milestones 3, 4, and 5 can be worked on in parallel after Milestones 1-2 are complete
- **Translation Strategy:** Start with English, use GPT-4 for initial translations, then human review by native speakers
- **Low-Bandwidth Testing:** Use Chrome DevTools throttling (Slow 3G) for all testing
- **Municipality Onboarding:** After v0.1, focus on onboarding 2-3 pilot municipalities for feedback

---

## Future Considerations (Post-v0.1)

- GIS property lookup with OpenStreetMap integration
- 311 issue reporting with geotagging
- Mobile app (React Native)
- AI-assisted citizen services (chatbot)
- Data analytics and transparency dashboards
- Digital land registry
- Integration with diaspora remittance platforms
